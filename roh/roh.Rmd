---
title: "Runs of homozygosity on 1082 individuals"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressMessages(library(knitr))
```

```{r, echo=FALSE}
suppressMessages(library(tidyverse))
suppressMessages(library(gridExtra))
suppressMessages(library(grid))
suppressMessages(library(data.table))

outlier <- function (x) {
  IQR <- quantile(x)[[4]] - quantile(x)[[2]]
  low <- quantile(x)[[2]] - 1.5*IQR
  high <- quantile(x)[[4]] + 1.5*IQR
  out_val <- x[x < low | x > high]
  return(out_val)
}
```



```{r echo=FALSE}
roh <- fread('../input/roh_concat.txt', showProgress = T)
colnames(roh) <- c("Chromosome", "Start", 'End', 'Length', 'Number_of_markers', 'Quality','sample_id')
roh$sample_id <-gsub(".*/(.*)\\..*", "\\1", roh$sample_id)

kable(roh %>% select(Length,Number_of_markers,Quality) %>%
  pivot_longer(cols = everything(), names_to = 'stat',values_to = 'value') %>%
  group_by(stat) %>%
  summarise(min = round(min(value),2),median=round(median(value),2),mean=round(mean(value),2),
            max=round(max(value),2))
)

```

ROHs quality histogram

All ROHs with Quality < 25% are removed 

```{r echo=FALSE}
roh  %>% ggplot(aes(x=1,y=Quality)) +
    geom_violin(fill='#48C095', col='#27384A') +
  geom_boxplot(width=0.1) +
     theme_classic() + theme(axis.text.x = element_blank()) +
  xlab('')
```

Number of ROHs with length in specific ranges

```{r roh, echo=FALSE}
 
 test1 <- roh$Length > 1e+06
 test2 <- roh$Length < 25e+03

 roh <- roh %>%
     mutate(group = case_when(test1 ~ ">1Mb",
                              (test2) ~ "<25kb" ,
                              !test1 & !test2 ~ "25kb-1Mb"
     ))


roh$group <- factor(roh$group)
roh$group <- ordered(roh$group, levels = c("<25kb", "25kb-1Mb", ">1Mb"))
  
 roh  %>% filter(Quality > 25) %>%
 ggplot(aes(y=1,x=Length)) +
 geom_violin(fill='#48C095', col='#27384A') +
 geom_boxplot(width=0.1) +
 theme_classic() +
 ylab('') +
  theme(axis.text.y = element_blank()) +
  facet_wrap(~group,scales = 'free',nrow=3)


```
% of ROhs per category in sample (mam problem z nasza paleta kolorow wiec na razie daje domyslna)


```{r roh_count, echo=FALSE}
group.colors <- c(`<25kb` = "#27384A", `>25kb-1Mb` ="#48C095", `>1Mb` = "#B6B6B6")

roh_count <- roh  %>% 
 filter(Quality > 25) %>%
 group_by(group,sample_id,.drop = F) %>% 
 summarise(n=n()) %>% arrange(group,n)

roh_count %>% 
 ggplot(aes(x=sample_id,y=n,fill=group)) +
 geom_bar(position="fill", stat="identity",width = 1) +
 #scale_fill_manual(values=group.colors) +
 theme_classic() +
 xlab('Individuals') +
 ylab('% of ROHs') +
 theme(axis.text.x = element_blank())
```

Number of ROHs per sample

```{r roh_count_per_sample, echo=FALSE} 
roh_avg <- roh %>% group_by(sample_id, group) %>%
  summarise(avg_length=mean(Length), n=n()) %>%
  arrange(group,n)

roh_avg %>%
  ggplot(aes(x=1:3246,y=n)) +
  geom_point(col='#48C095',alpha=0.5) +
  facet_wrap(~group, nrow = 3,scales = 'free') + 
  ylab('Number of ROHs') +
  xlab('Individual') +
  theme_classic() +
  theme(axis.text.x = element_blank())
 
```


Average ROHs per sample


```{r average_roh_per_sample, echo=FALSE} 
roh_avg <- roh %>% group_by(sample_id, group) %>%
  summarise(avg_length=mean(Length), n=n()) %>%
  arrange(group,avg_length)

roh_avg %>%
  ggplot(aes(x=1:3246,y=avg_length)) +
  geom_point(col='#48C095',alpha=0.5) +
  facet_wrap(~group, nrow = 3,scales = 'free') + 
  ylab('Mean ROH length') +
  xlab('Individual') +
  theme_classic() +
  theme(axis.text.x = element_blank())
 
```

Cosanguinity in population

```{r echo=FALSE}
froh <- read.table('../output/roh/froh.output',header=T,sep='\t')

froh %>% ggplot(aes(x=1,y=Froh_genome)) +
    geom_violin(fill='#48C095', col='#27384A') +
  geom_boxplot(width=0.1) +
     theme_classic() + theme(axis.text.x = element_blank()) +
  xlab('')

```