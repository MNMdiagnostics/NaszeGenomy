---
title: "Runs of homozygosity on 943 individuals"
output: github_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
suppressMessages(library(knitr))
```


```{r, echo=FALSE}
suppressMessages(library(tidyverse))
suppressMessages(library(gridExtra))
suppressMessages(library(grid))
suppressMessages(library(data.table))

outlier <- function (x) {
  IQR <- quantile(x)[[4]] - quantile(x)[[2]]
  low <- quantile(x)[[2]] - 1.5*IQR
  high <- quantile(x)[[4]] + 1.5*IQR
  out_val <- x[x < low | x > high]
  return(out_val)
}
```



```{r echo=FALSE}
roh <- fread('../input/roh_concat.txt', showProgress = T)
colnames(roh) <- c("Chromosome", "Start", 'End', 'Length', 'Number_of_markers', 'Quality','sample_id')
roh$sample_id <-gsub(".*/(.*)\\..*", "\\1", roh$sample_id)
roh$sample_id <-gsub(".norm.roh", "", roh$sample_id)
to_include <- read.table('../../../genom_polaka/SAMPLES_TO_INCLUDE_210519.txt',sep='\t')

roh <- roh %>% filter(sample_id %in% to_include$V1)



kable(roh %>% select(Length,Number_of_markers,Quality) %>%
  pivot_longer(cols = everything(), names_to = 'stat',values_to = 'value') %>%
  group_by(stat) %>%
  summarise(min = round(min(value),2),median=round(median(value),2),mean=round(mean(value),2),
            max=round(max(value),2))
)

```

ROHs quality histogram

```{r echo=FALSE}
roh  %>% ggplot(aes(x=1,y=Quality)) +
    geom_violin(fill='#48C095', col='#27384A') +
  geom_boxplot(width=0.1) +
     theme_classic() + theme(axis.text.x = element_blank()) +
  xlab('')
```

## Results

### All results below are ROHs filter for autosomes with Quality > 25% and Number of markers >= 50

1. Average sum of ROHs

```{r total_roh, echo=FALSE}
roh <- roh  %>% filter(Quality > 25 & Number_of_markers >= 50 & Length > 2e+06) %>%
  filter(Chromosome != 'chrX' & Chromosome != 'chrY')
roh$Range <- ifelse(roh$Length >= 10e+06, '>10Mb','2-5Mb')

group.colors <- c('2-5Mb' = '#48C095', '>10Mb' = '#27384A')

#roh$Chromosome <- gsub('chr','',roh$Chromosome)
#roh$Chromosome <- as.numeric(roh$Chromosome)

roh$Chromosome <- factor(roh$Chromosome)
roh$Chromosome <- ordered(roh$Chromosome, levels = unique(roh$Chromosome))

roh %>% group_by(sample_id) %>%
  summarise(SROH_Mb = sum(Length)/1e+06) %>%
  ggplot(aes(y=1,x=SROH_Mb)) +
  geom_violin(fill='#48C095', col='#27384A') +
  geom_boxplot(width=0.1) +
  theme_classic() +
  xlab('SROH (Mb)') +
  ylab('') +
  theme(axis.text.y = element_blank())

kable(summary(
  roh %>% group_by(sample_id) %>%
  summarise(mean_SROH_Mb = sum(Length)/1e+06) %>%
    select(mean_SROH_Mb)
  )
  
)
```

2. Sum of ROH length per range

```{r SROH, echo=FALSE}
sroh <- roh %>% filter(Chromosome != 'chrX' & Chromosome != 'chrY') %>%
  filter(Length >= 2e+06 & Length <= 5e+06 | Length >= 10e+06 & Number_of_markers >= 50)
  
sroh_sum <- sroh %>% group_by(Range,sample_id) %>% summarise(SROH = sum(Length)/1e+06)

sroh_sum %>% ggplot(aes(y=Range,x=SROH)) +
 geom_violin(fill='#48C095', col='#27384A') +
 geom_boxplot(width=0.1) +
 theme_classic() +
 ylab('Range') +
 xlab('SROH (Mb)')

kable(
  summary(sroh_sum %>% 
            pivot_wider(names_from = Range, values_from = SROH) %>%
            select(-sample_id) %>% na.omit()
          )
)


```


3. Relationship between number of ROHs and total length of genome covered by them

```{r cummulative, echo=FALSE} 
croh <- roh %>% filter(Chromosome != 'chrX' & Chromosome != 'chrY' & Number_of_markers >= 50) 

croh_sum <- croh %>% group_by(sample_id) %>% 
  summarise(n = n(), sum = sum(Length)/1e+06)

croh_sum %>% ggplot(aes(y=n,x=sum)) +
  geom_point(col='#48C095') +
  theme_classic() +
  ylab('Number of ROH') +
  xlab('Total Length in ROH (Mb)')
```


4. ROH genome coverage with runs > 2Mb

```{r genome_coverage, echo=FALSE}
#chr <- c('chr22')
coverage <- roh %>% #filter(Chromosome %in% chr) %>%
  arrange(Chromosome,Start)
coverage$Chromosome <- paste(coverage$Chromosome,sep='')
coverage$x_from <- paste(coverage$Chromosome,coverage$Start,sep='')
coverage$x_end <- paste(coverage$Chromosome,coverage$End,sep='')

coverage %>% ggplot() +
  geom_segment(aes(x = x_from, y = sample_id, xend = x_end, 
                                 yend = sample_id), col='#48C095') +
  theme_classic() +
  theme(axis.text.x = element_blank(),axis.text.y = element_blank()) +
  xlab('Position on genome') +
  ylab('Individual')

```


5. % of ROhs per category in sample

```{r roh_count, echo=FALSE}
suppressMessages(
roh_count <- roh  %>% 
 group_by(Range,sample_id,.drop = F) %>% 
 summarise(n=n()) %>% arrange(Range,n)
)

roh_count %>% 
 ggplot(aes(x=reorder(sample_id,-n),y=n,fill=Range)) +
 geom_bar(position="fill", stat="identity",width = 1) +
 scale_fill_manual(values=group.colors) +
 theme_classic() +
 xlab('Individuals') +
 ylab('% of ROHs count') +
 theme(axis.text.x = element_blank())
```

6. ROH length sum

```{r roh_sum, echo=FALSE}
suppressMessages(
roh_sum <- roh  %>% 
 group_by(Range,sample_id,.drop = F) %>% 
 summarise(sum=sum(Length)) %>% arrange(Range,sum)
)

roh_sum %>% 
 ggplot(aes(x=reorder(sample_id,-sum),y=sum,fill=Range)) +
 geom_bar(position="fill", stat="identity",width = 1) +
 scale_fill_manual(values=group.colors) +
 theme_classic() +
 xlab('Individuals') +
 ylab('% of ROHs length sum') +
 theme(axis.text.x = element_blank())
```

7. Number of ROHs per sample

```{r roh_count_per_sample, echo=FALSE} 
suppressMessages(
roh_avg <- roh %>% group_by(sample_id, Range) %>%
  summarise(avg_length=mean(Length), n=n()) %>%
  arrange(Range,n)
)

roh_avg %>%
  ggplot(aes(x=1:nrow(roh_avg),y=n)) +
  geom_point(col='#48C095',alpha=0.5) +
  facet_wrap(~Range, nrow = 3,scales = 'free') + 
  ylab('Number of ROHs') +
  xlab('Individual') +
  theme_classic() +
  theme(axis.text.x = element_blank())
 
```

8. Average ROHs per sample

```{r average_roh_per_sample, echo=FALSE} 
roh_avg <- roh %>% group_by(sample_id, Range) %>%
  summarise(avg_length=mean(Length), n=n()) %>%
  arrange(Range,avg_length)

roh_avg %>%
  ggplot(aes(x=1:nrow(roh_avg),y=avg_length)) +
  geom_point(col='#48C095',alpha=0.5) +
  facet_wrap(~Range, nrow = 3,scales = 'free') + 
  ylab('Mean ROH length') +
  xlab('Individual') +
  theme_classic() +
  theme(axis.text.x = element_blank())
 
```

9. Cosanguinity in population

```{r echo=FALSE}
froh <- read.table('../output/roh/froh.output',header=T,sep='\t')

froh %>% ggplot(aes(x=1,y=Froh_genome)) +
    geom_violin(fill='#48C095', col='#27384A') +
  geom_boxplot(width=0.1) +
     theme_classic() + theme(axis.text.x = element_blank()) +
  xlab('')

```